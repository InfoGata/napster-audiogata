class A extends Error{response;request;options;constructor(t,s,o){const a=t.status||t.status===0?t.status:"",r=t.statusText||"",n=`${a} ${r}`.trim(),i=n?`status code ${n}`:"an unknown error";super(`Request failed with ${i}: ${s.method} ${s.url}`),this.name="HTTPError",this.response=t,this.request=s,this.options=o}}class E extends Error{request;constructor(t){super(`Request timed out: ${t.method} ${t.url}`),this.name="TimeoutError",this.request=t}}const d=e=>e!==null&&typeof e=="object",b=(...e)=>{for(const t of e)if((!d(t)||Array.isArray(t))&&t!==void 0)throw new TypeError("The `options` argument must be an object");return I({},...e)},C=(e={},t={})=>{const s=new globalThis.Headers(e),o=t instanceof globalThis.Headers,a=new globalThis.Headers(t);for(const[r,n]of a.entries())o&&n==="undefined"||n===void 0?s.delete(r):s.set(r,n);return s};function w(e,t,s){return Object.hasOwn(t,s)&&t[s]===void 0?[]:I(e[s]??[],t[s]??[])}const N=(e={},t={})=>({beforeRequest:w(e,t,"beforeRequest"),beforeRetry:w(e,t,"beforeRetry"),afterResponse:w(e,t,"afterResponse"),beforeError:w(e,t,"beforeError")}),I=(...e)=>{let t={},s={},o={};for(const a of e)if(Array.isArray(a))Array.isArray(t)||(t=[]),t=[...t,...a];else if(d(a)){for(let[r,n]of Object.entries(a))d(n)&&r in t&&(n=I(t[r],n)),t={...t,[r]:n};d(a.hooks)&&(o=N(o,a.hooks),t.hooks=o),d(a.headers)&&(s=C(s,a.headers),t.headers=s)}return t},H=(()=>{let e=!1,t=!1;const s=typeof globalThis.ReadableStream=="function",o=typeof globalThis.Request=="function";if(s&&o)try{t=new globalThis.Request("https://empty.invalid",{body:new globalThis.ReadableStream,method:"POST",get duplex(){return e=!0,"half"}}).headers.has("Content-Type")}catch(a){if(a instanceof Error&&a.message==="unsupported BodyInit type")return!1;throw a}return e&&!t})(),J=typeof globalThis.AbortController=="function",z=typeof globalThis.ReadableStream=="function",K=typeof globalThis.FormData=="function",U=["get","post","put","patch","head","delete"],B={json:"application/json",text:"text/*",formData:"multipart/form-data",arrayBuffer:"*/*",blob:"*/*"},k=2147483647,j=Symbol("stop"),G={json:!0,parseJson:!0,stringifyJson:!0,searchParams:!0,prefixUrl:!0,retry:!0,timeout:!0,hooks:!0,throwHttpErrors:!0,onDownloadProgress:!0,fetch:!0},F={method:!0,headers:!0,body:!0,mode:!0,credentials:!0,cache:!0,redirect:!0,referrer:!0,referrerPolicy:!0,integrity:!0,keepalive:!0,signal:!0,window:!0,dispatcher:!0,duplex:!0,priority:!0},V=e=>U.includes(e)?e.toUpperCase():e,Y=["get","put","head","delete","options","trace"],W=[408,413,429,500,502,503,504],X=[413,429,503],P={limit:2,methods:Y,statusCodes:W,afterStatusCodes:X,maxRetryAfter:Number.POSITIVE_INFINITY,backoffLimit:Number.POSITIVE_INFINITY,delay:e=>.3*2**(e-1)*1e3},Q=(e={})=>{if(typeof e=="number")return{...P,limit:e};if(e.methods&&!Array.isArray(e.methods))throw new Error("retry.methods must be an array");if(e.statusCodes&&!Array.isArray(e.statusCodes))throw new Error("retry.statusCodes must be an array");return{...P,...e}};async function Z(e,t,s,o){return new Promise((a,r)=>{const n=setTimeout(()=>{s&&s.abort(),r(new E(e))},o.timeout);o.fetch(e,t).then(a).catch(r).then(()=>{clearTimeout(n)})})}async function tt(e,{signal:t}){return new Promise((s,o)=>{t&&(t.throwIfAborted(),t.addEventListener("abort",a,{once:!0}));function a(){clearTimeout(r),o(t.reason)}const r=setTimeout(()=>{t?.removeEventListener("abort",a),s()},e)})}const et=(e,t)=>{const s={};for(const o in t)!(o in F)&&!(o in G)&&!(o in e)&&(s[o]=t[o]);return s};class _{static create(t,s){const o=new _(t,s),a=async()=>{if(typeof o._options.timeout=="number"&&o._options.timeout>k)throw new RangeError(`The \`timeout\` option cannot be greater than ${k}`);await Promise.resolve();let i=await o._fetch();for(const u of o._options.hooks.afterResponse){const c=await u(o.request,o._options,o._decorateResponse(i.clone()));c instanceof globalThis.Response&&(i=c)}if(o._decorateResponse(i),!i.ok&&o._options.throwHttpErrors){let u=new A(i,o.request,o._options);for(const c of o._options.hooks.beforeError)u=await c(u);throw u}if(o._options.onDownloadProgress){if(typeof o._options.onDownloadProgress!="function")throw new TypeError("The `onDownloadProgress` option must be a function");if(!z)throw new Error("Streams are not supported in your environment. `ReadableStream` is missing.");return o._stream(i.clone(),o._options.onDownloadProgress)}return i},n=o._options.retry.methods.includes(o.request.method.toLowerCase())?o._retry(a):a();for(const[i,u]of Object.entries(B))n[i]=async()=>{o.request.headers.set("accept",o.request.headers.get("accept")||u);const c=await n;if(i==="json"){if(c.status===204||(await c.clone().arrayBuffer()).byteLength===0)return"";if(s.parseJson)return s.parseJson(await c.text())}return c[i]()};return n}request;abortController;_retryCount=0;_input;_options;constructor(t,s={}){if(this._input=t,this._options={...s,headers:C(this._input.headers,s.headers),hooks:N({beforeRequest:[],beforeRetry:[],beforeError:[],afterResponse:[]},s.hooks),method:V(s.method??this._input.method??"GET"),prefixUrl:String(s.prefixUrl||""),retry:Q(s.retry),throwHttpErrors:s.throwHttpErrors!==!1,timeout:s.timeout??1e4,fetch:s.fetch??globalThis.fetch.bind(globalThis)},typeof this._input!="string"&&!(this._input instanceof URL||this._input instanceof globalThis.Request))throw new TypeError("`input` must be a string, URL, or Request");if(this._options.prefixUrl&&typeof this._input=="string"){if(this._input.startsWith("/"))throw new Error("`input` must not begin with a slash when using `prefixUrl`");this._options.prefixUrl.endsWith("/")||(this._options.prefixUrl+="/"),this._input=this._options.prefixUrl+this._input}if(J){this.abortController=new globalThis.AbortController;const o=this._options.signal??this._input.signal;o?.aborted&&this.abortController.abort(o?.reason),o?.addEventListener("abort",()=>{this.abortController.abort(o.reason)}),this._options.signal=this.abortController.signal}if(H&&(this._options.duplex="half"),this._options.json!==void 0&&(this._options.body=this._options.stringifyJson?.(this._options.json)??JSON.stringify(this._options.json),this._options.headers.set("content-type",this._options.headers.get("content-type")??"application/json")),this.request=new globalThis.Request(this._input,this._options),this._options.searchParams){const a="?"+(typeof this._options.searchParams=="string"?this._options.searchParams.replace(/^\?/,""):new URLSearchParams(this._options.searchParams).toString()),r=this.request.url.replace(/(?:\?.*?)?(?=#|$)/,a);(K&&this._options.body instanceof globalThis.FormData||this._options.body instanceof URLSearchParams)&&!(this._options.headers&&this._options.headers["content-type"])&&this.request.headers.delete("content-type"),this.request=new globalThis.Request(new globalThis.Request(r,{...this.request}),this._options)}}_calculateRetryDelay(t){if(this._retryCount++,this._retryCount>this._options.retry.limit||t instanceof E)throw t;if(t instanceof A){if(!this._options.retry.statusCodes.includes(t.response.status))throw t;const o=t.response.headers.get("Retry-After")??t.response.headers.get("RateLimit-Reset")??t.response.headers.get("X-RateLimit-Reset")??t.response.headers.get("X-Rate-Limit-Reset");if(o&&this._options.retry.afterStatusCodes.includes(t.response.status)){let a=Number(o)*1e3;Number.isNaN(a)?a=Date.parse(o)-Date.now():a>=Date.parse("2024-01-01")&&(a-=Date.now());const r=this._options.retry.maxRetryAfter??a;return a<r?a:r}if(t.response.status===413)throw t}const s=this._options.retry.delay(this._retryCount);return Math.min(this._options.retry.backoffLimit,s)}_decorateResponse(t){return this._options.parseJson&&(t.json=async()=>this._options.parseJson(await t.text())),t}async _retry(t){try{return await t()}catch(s){const o=Math.min(this._calculateRetryDelay(s),k);if(this._retryCount<1)throw s;await tt(o,{signal:this._options.signal});for(const a of this._options.hooks.beforeRetry)if(await a({request:this.request,options:this._options,error:s,retryCount:this._retryCount})===j)return;return this._retry(t)}}async _fetch(){for(const o of this._options.hooks.beforeRequest){const a=await o(this.request,this._options);if(a instanceof Request){this.request=a;break}if(a instanceof Response)return a}const t=et(this.request,this._options),s=this.request;return this.request=s.clone(),this._options.timeout===!1?this._options.fetch(s,t):Z(s,t,this.abortController,this._options)}_stream(t,s){const o=Number(t.headers.get("content-length"))||0;let a=0;return t.status===204?(s&&s({percent:1,totalBytes:o,transferredBytes:a},new Uint8Array),new globalThis.Response(null,{status:t.status,statusText:t.statusText,headers:t.headers})):new globalThis.Response(new globalThis.ReadableStream({async start(r){const n=t.body.getReader();s&&s({percent:0,transferredBytes:0,totalBytes:o},new Uint8Array);async function i(){const{done:u,value:c}=await n.read();if(u){r.close();return}if(s){a+=c.byteLength;const g=o===0?0:a/o;s({percent:g,transferredBytes:a,totalBytes:o},c)}r.enqueue(c),await i()}await i()}}),{status:t.status,statusText:t.statusText,headers:t.headers})}}/*! MIT License Â© Sindre Sorhus */const R=e=>{const t=(s,o)=>_.create(s,b(e,o));for(const s of U)t[s]=(o,a)=>_.create(o,b(e,a,{method:s}));return t.create=s=>R(b(s)),t.extend=s=>(typeof s=="function"&&(s=s(e??{})),R(b(e,s))),t.stop=j,t},p=R(),x="MWRiNTQ1NDctM2EyYi00NzcxLTlhNWYtMDdlNGViM2NkYWJj",st="https://cloudflare-worker-token-service.audio-pwa.workers.dev/token",ot="https://api.napster.com/oauth/access_token";let m;const q=e=>{application.postUiMessage(e)},h=()=>localStorage.getItem("apiKey")||x,f=p.create({hooks:{beforeRequest:[e=>{const t=localStorage.getItem("auth");t&&(m=JSON.parse(t),e.headers.set("Authorization",`Bearer ${m?.access_token}`))}],afterResponse:[async(e,t,s)=>{if(s.status===401){const o=await at();return e.headers.set("Authorization",`Bearer ${o}`),f(e,t)}}]}}),at=async()=>{if(!m)return;const e=localStorage.getItem("clientId"),t=localStorage.getItem("clientSecret");let s=st;const o=new URLSearchParams;o.append("client_id",e||x),o.append("grant_type","refresh_token"),o.append("refresh_token",m.refresh_token),o.append("response_type","code"),e&&t&&(o.append("client_secret",t),s=ot);const a=await p.post(s,{headers:{"Content-Type":"application/x-www-form-urlencoded"},body:o}).json();if(a.access_token&&a.refresh_token)return localStorage.setItem("auth",JSON.stringify(a)),a.access_token},l="https://api.napster.com/v2.2";function T(e){return e.map(t=>({apiId:t.id.toString(),artistApiId:t.contributingArtists.primaryArtist,artistName:t.artistName,name:t.name,images:$(t.id)}))}function rt(e){return e.map(t=>({apiId:t.id.toString(),name:t.name,images:S(t.id)}))}function $(e){return[70,170,200,300,500].map(s=>({height:s,url:`https://api.napster.com/imageserver/v2/albums/${e}/images/${s}x${s}.jpg`,width:s}))}function S(e){return[{width:70,height:47},{width:150,height:100},{width:356,height:237},{width:633,height:422}].map(s=>({height:s.height,width:s.width,url:`https://api.napster.com/imageserver/v2/artists/${e}/images/${s.width}x${s.height}.jpg`}))}function y(e){return e.map(t=>({albumApiId:t.albumId,apiId:t.id,artistApiId:t.artistId,artistName:t.artistName,duration:t.playbackSeconds,images:$(t.albumId),name:t.name}))}const v=async()=>{m&&(application.onGetUserPlaylists=ut,application.onGetTopItems=mt)},nt=async()=>{const t=document.location.host.split(".");t.shift();const s=t.join("."),o=`${document.location.protocol}//${s}`,a=await application.getPluginId(),r=localStorage.getItem("apiKey")??"",n=localStorage.getItem("apiSecret")??"";q({type:"info",origin:o,pluginId:a,apiKey:r,apiSecret:n})};application.onUiMessage=async e=>{switch(e.type){case"login":m=e.auth,localStorage.setItem("auth",JSON.stringify(m)),v();break;case"logout":localStorage.removeItem("auth");break;case"check-login":const t=localStorage.getItem("auth");t&&q({type:"login",auth:JSON.parse(t)}),await nt();break;case"set-keys":localStorage.setItem("apiKey",e.apiKey),localStorage.setItem("apiSecret",e.apiSecret);break}};application.onDeepLinkMessage=async e=>{application.postUiMessage({type:"deeplink",url:e})};async function it(e){const s=`${l}/artists/${e.apiId}?apikey=${h()}`,o=e.sortBy||"top";let a;switch(o){case"release_date":a="/albums";break;case"new":a="/albums/new";break;case"top":default:a="/albums/top";break}const r=`${l}/artists/${e.apiId}${a}?apikey=${h()}&limit=200`;try{const n=await p.get(s).json(),u=(await p.get(r).json()).albums,c=n.artists[0],g=[{displayName:"Top Albums",value:"top"},{displayName:"Release Date",value:"release_date"},{displayName:"New Releases",value:"new"}];return{items:T(u),artist:{name:c.name,apiId:e.apiId||"",images:S(e.apiId||"")},sortOptions:g,sortBy:o}}catch{return{items:[]}}}async function ct(e){const s=e.pageInfo?.offset||0,o=`${l}/artists/${e.apiId}?apikey=${h()}`,a=`${l}/artists/${e.apiId}/tracks/top?apikey=${h()}&limit=10&offset=${s}`;try{const r=await p.get(o).json(),n=await p.get(a).json(),i=n.tracks,u=r.artists[0],c={offset:s,totalResults:n.meta.totalCount,resultsPerPage:10};return{items:y(i),pageInfo:c,artist:{name:u.name,apiId:e.apiId||"",images:S(e.apiId||"")}}}catch{return{items:[]}}}async function lt(e){const t=`${l}/albums/${e.apiId}?apikey=${h()}`,s=`${l}/albums/${e.apiId}/tracks?apikey=${h()}`;try{const o=await p.get(t).json(),r=(await p.get(s).json()).tracks,n=o.albums[0];return{items:y(r),album:{artistName:n.artistName,artistApiId:n.contributingArtists.primaryArtist,apiId:e.apiId||"",name:n.name,images:$(e.apiId||"")}}}catch{return{items:[]}}}async function ut(e){if(!m)return{items:[]};const t=`${l}/me/library/playlists`;return{items:(await f.get(t).json()).playlists.map(a=>({name:a.name,images:a.images,apiId:a.id}))}}async function pt(e){const s=`${l}/playlists/${e.apiId}?apikey=${h()}`,o=`${l}/playlists/${e.apiId}/tracks?apikey=${h()}&limit=200`,a=await f.get(s).json(),r=await f.get(o).json();return{playlist:{name:a.playlists[0].name,images:a.playlists[0].images},items:y(r.tracks)}}async function O(e){const s=e.pageInfo?.offset||0,o=`${l}/search?apikey=${h()}&query=${encodeURIComponent(e.query)}&type=artist&per_type_limit=20&offset=${s}`;try{const a=await p.get(o).json(),r=a.search.data.artists,n={offset:s,totalResults:a.meta.totalCount,resultsPerPage:20};return{items:rt(r),pageInfo:n}}catch{return{items:[]}}}async function L(e){const s=e.pageInfo?.offset||0,o=`${l}/search?apikey=${h()}&query=${encodeURIComponent(e.query)}&type=album&per_type_limit=20&offset=${s}`;try{const a=await p.get(o).json(),r=a.search.data.albums,n={offset:s,totalResults:a.meta.totalCount,resultsPerPage:20};return{items:T(r),pageInfo:n}}catch{return{items:[]}}}async function M(e){const s=e.pageInfo?.offset||0,o=`${l}/search?apikey=${h()}&query=${encodeURIComponent(e.query)}&type=track&per_type_limit=20&offset=${s}`;try{const a=await p.get(o).json(),r=a.search.data.tracks,n={offset:s,totalResults:a.meta.totalCount,resultsPerPage:20};return{items:y(r),pageInfo:n}}catch{return{items:[]}}}async function ht(e){const[t,s,o]=await Promise.all([M(e),L(e),O(e)]);return{tracks:t,albums:s,artists:o}}async function mt(){const e=`${l}/me/personalized/tracks/new?limit=20`,t=`${l}/me/personalized/albums/new?limit=20`,[s,o]=await Promise.all([f.get(e).json(),f.get(t).json()]);return{tracks:{items:y(s.tracks)},albums:{items:T(o.albums)}}}const D=e=>{localStorage.setItem("kb-color-mode",e)};async function ft(e){if(!m||!e.apiId)throw new Error("No authentication or track ID available");const t=`${l}/streams`;try{const s=await f.get(t,{searchParams:{track:e.apiId,bitrate:320,format:"AAC",protocol:""}}).json();if(s.streams&&s.streams.length>0)return s.streams[0].url;throw new Error("No stream URL available")}catch(s){throw new Error(`Failed to get stream URL: ${s}`)}}const dt=async()=>{application.onSearchAll=ht,application.onSearchAlbums=L,application.onSearchTracks=M,application.onSearchArtists=O,application.onGetAlbumTracks=lt,application.onGetArtistAlbums=it,application.onGetArtistTopTracks=ct,application.onGetPlaylistTracks=pt,application.onGetTrackUrl=ft;const e=localStorage.getItem("auth");e&&(m=JSON.parse(e),v());const t=await application.getTheme();D(t)};application.onChangeTheme=async e=>{D(e)};dt();
