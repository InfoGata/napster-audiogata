(()=>{let t,e;/*! MIT License Â© Sindre Sorhus */class s extends Error{response;request;options;constructor(t,e,s){let r=t.status||0===t.status?t.status:"",a=t.statusText||"",o=`${r} ${a}`.trim();super(`Request failed with ${o?`status code ${o}`:"an unknown error"}: ${e.method} ${e.url}`),this.name="HTTPError",this.response=t,this.request=e,this.options=s}}class r extends Error{request;constructor(t){super(`Request timed out: ${t.method} ${t.url}`),this.name="TimeoutError",this.request=t}}let a=t=>null!==t&&"object"==typeof t,o=(...t)=>{for(let e of t)if((!a(e)||Array.isArray(e))&&void 0!==e)throw TypeError("The `options` argument must be an object");return p({},...t)},i=(t={},e={})=>{let s=new globalThis.Headers(t),r=e instanceof globalThis.Headers;for(let[t,a]of new globalThis.Headers(e).entries())r&&"undefined"===a||void 0===a?s.delete(t):s.set(t,a);return s};function n(t,e,s){return Object.hasOwn(e,s)&&void 0===e[s]?[]:p(t[s]??[],e[s]??[])}let l=(t={},e={})=>({beforeRequest:n(t,e,"beforeRequest"),beforeRetry:n(t,e,"beforeRetry"),afterResponse:n(t,e,"afterResponse"),beforeError:n(t,e,"beforeError")}),p=(...t)=>{let e={},s={},r={};for(let o of t)if(Array.isArray(o))Array.isArray(e)||(e=[]),e=[...e,...o];else if(a(o)){for(let[t,s]of Object.entries(o))a(s)&&t in e&&(s=p(e[t],s)),e={...e,[t]:s};a(o.hooks)&&(r=l(r,o.hooks),e.hooks=r),a(o.headers)&&(s=i(s,o.headers),e.headers=s)}return e},c=(()=>{let t=!1,e=!1,s="function"==typeof globalThis.Request;if("function"==typeof globalThis.ReadableStream&&s)try{e=new globalThis.Request("https://empty.invalid",{body:new globalThis.ReadableStream,method:"POST",get duplex(){return t=!0,"half"}}).headers.has("Content-Type")}catch(t){if(t instanceof Error&&"unsupported BodyInit type"===t.message)return!1;throw t}return t&&!e})(),h="function"==typeof globalThis.AbortController,u="function"==typeof globalThis.ReadableStream,m="function"==typeof globalThis.FormData,y=["get","post","put","patch","head","delete"],d={json:"application/json",text:"text/*",formData:"multipart/form-data",arrayBuffer:"*/*",blob:"*/*"},f=Symbol("stop"),g={json:!0,parseJson:!0,stringifyJson:!0,searchParams:!0,prefixUrl:!0,retry:!0,timeout:!0,hooks:!0,throwHttpErrors:!0,onDownloadProgress:!0,fetch:!0},b={method:!0,headers:!0,body:!0,mode:!0,credentials:!0,cache:!0,redirect:!0,referrer:!0,referrerPolicy:!0,integrity:!0,keepalive:!0,signal:!0,window:!0,dispatcher:!0,duplex:!0,priority:!0},w=t=>y.includes(t)?t.toUpperCase():t,_={limit:2,methods:["get","put","head","delete","options","trace"],statusCodes:[408,413,429,500,502,503,504],afterStatusCodes:[413,429,503],maxRetryAfter:Number.POSITIVE_INFINITY,backoffLimit:Number.POSITIVE_INFINITY,delay:t=>.3*2**(t-1)*1e3},k=(t={})=>{if("number"==typeof t)return{..._,limit:t};if(t.methods&&!Array.isArray(t.methods))throw Error("retry.methods must be an array");if(t.statusCodes&&!Array.isArray(t.statusCodes))throw Error("retry.statusCodes must be an array");return{..._,...t}};async function T(t,e,s,a){return new Promise((o,i)=>{let n=setTimeout(()=>{s&&s.abort(),i(new r(t))},a.timeout);a.fetch(t,e).then(o).catch(i).then(()=>{clearTimeout(n)})})}async function I(t,{signal:e}){return new Promise((s,r)=>{function a(){clearTimeout(o),r(e.reason)}e&&(e.throwIfAborted(),e.addEventListener("abort",a,{once:!0}));let o=setTimeout(()=>{e?.removeEventListener("abort",a),s()},t)})}let R=(t,e)=>{let s={};for(let r in e)r in b||r in g||r in t||(s[r]=e[r]);return s};class S{static create(t,e){let r=new S(t,e),a=async()=>{if("number"==typeof r._options.timeout&&r._options.timeout>2147483647)throw RangeError("The `timeout` option cannot be greater than 2147483647");await Promise.resolve();let t=await r._fetch();for(let e of r._options.hooks.afterResponse){let s=await e(r.request,r._options,r._decorateResponse(t.clone()));s instanceof globalThis.Response&&(t=s)}if(r._decorateResponse(t),!t.ok&&r._options.throwHttpErrors){let e=new s(t,r.request,r._options);for(let t of r._options.hooks.beforeError)e=await t(e);throw e}if(r._options.onDownloadProgress){if("function"!=typeof r._options.onDownloadProgress)throw TypeError("The `onDownloadProgress` option must be a function");if(!u)throw Error("Streams are not supported in your environment. `ReadableStream` is missing.");return r._stream(t.clone(),r._options.onDownloadProgress)}return t},o=r._options.retry.methods.includes(r.request.method.toLowerCase())?r._retry(a):a();for(let[t,s]of Object.entries(d))o[t]=async()=>{r.request.headers.set("accept",r.request.headers.get("accept")||s);let a=await o;if("json"===t){if(204===a.status||0===(await a.clone().arrayBuffer()).byteLength)return"";if(e.parseJson)return e.parseJson(await a.text())}return a[t]()};return o}request;abortController;_retryCount=0;_input;_options;constructor(t,e={}){if(this._input=t,this._options={...e,headers:i(this._input.headers,e.headers),hooks:l({beforeRequest:[],beforeRetry:[],beforeError:[],afterResponse:[]},e.hooks),method:w(e.method??this._input.method??"GET"),prefixUrl:String(e.prefixUrl||""),retry:k(e.retry),throwHttpErrors:!1!==e.throwHttpErrors,timeout:e.timeout??1e4,fetch:e.fetch??globalThis.fetch.bind(globalThis)},"string"!=typeof this._input&&!(this._input instanceof URL||this._input instanceof globalThis.Request))throw TypeError("`input` must be a string, URL, or Request");if(this._options.prefixUrl&&"string"==typeof this._input){if(this._input.startsWith("/"))throw Error("`input` must not begin with a slash when using `prefixUrl`");this._options.prefixUrl.endsWith("/")||(this._options.prefixUrl+="/"),this._input=this._options.prefixUrl+this._input}if(h){this.abortController=new globalThis.AbortController;let t=this._options.signal??this._input.signal;t?.aborted&&this.abortController.abort(t?.reason),t?.addEventListener("abort",()=>{this.abortController.abort(t.reason)}),this._options.signal=this.abortController.signal}if(c&&(this._options.duplex="half"),void 0!==this._options.json&&(this._options.body=this._options.stringifyJson?.(this._options.json)??JSON.stringify(this._options.json),this._options.headers.set("content-type",this._options.headers.get("content-type")??"application/json")),this.request=new globalThis.Request(this._input,this._options),this._options.searchParams){let t="string"==typeof this._options.searchParams?this._options.searchParams.replace(/^\?/,""):new URLSearchParams(this._options.searchParams).toString(),e=this.request.url.replace(/(?:\?.*?)?(?=#|$)/,"?"+t);(m&&this._options.body instanceof globalThis.FormData||this._options.body instanceof URLSearchParams)&&!(this._options.headers&&this._options.headers["content-type"])&&this.request.headers.delete("content-type"),this.request=new globalThis.Request(new globalThis.Request(e,{...this.request}),this._options)}}_calculateRetryDelay(t){if(this._retryCount++,this._retryCount>this._options.retry.limit||t instanceof r)throw t;if(t instanceof s){if(!this._options.retry.statusCodes.includes(t.response.status))throw t;let e=t.response.headers.get("Retry-After")??t.response.headers.get("RateLimit-Reset")??t.response.headers.get("X-RateLimit-Reset")??t.response.headers.get("X-Rate-Limit-Reset");if(e&&this._options.retry.afterStatusCodes.includes(t.response.status)){let t=1e3*Number(e);Number.isNaN(t)?t=Date.parse(e)-Date.now():t>=Date.parse("2024-01-01")&&(t-=Date.now());let s=this._options.retry.maxRetryAfter??t;return t<s?t:s}if(413===t.response.status)throw t}let e=this._options.retry.delay(this._retryCount);return Math.min(this._options.retry.backoffLimit,e)}_decorateResponse(t){return this._options.parseJson&&(t.json=async()=>this._options.parseJson(await t.text())),t}async _retry(t){try{return await t()}catch(s){let e=Math.min(this._calculateRetryDelay(s),2147483647);if(this._retryCount<1)throw s;for(let t of(await I(e,{signal:this._options.signal}),this._options.hooks.beforeRetry))if(await t({request:this.request,options:this._options,error:s,retryCount:this._retryCount})===f)return;return this._retry(t)}}async _fetch(){for(let t of this._options.hooks.beforeRequest){let e=await t(this.request,this._options);if(e instanceof Request){this.request=e;break}if(e instanceof Response)return e}let t=R(this.request,this._options),e=this.request;return(this.request=e.clone(),!1===this._options.timeout)?this._options.fetch(e,t):T(e,t,this.abortController,this._options)}_stream(t,e){let s=Number(t.headers.get("content-length"))||0,r=0;return 204===t.status?(e&&e({percent:1,totalBytes:s,transferredBytes:r},new Uint8Array),new globalThis.Response(null,{status:t.status,statusText:t.statusText,headers:t.headers})):new globalThis.Response(new globalThis.ReadableStream({async start(a){let o=t.body.getReader();async function i(){let{done:t,value:n}=await o.read();if(t){a.close();return}e&&(r+=n.byteLength,e({percent:0===s?0:r/s,transferredBytes:r,totalBytes:s},n)),a.enqueue(n),await i()}e&&e({percent:0,transferredBytes:0,totalBytes:s},new Uint8Array),await i()}}),{status:t.status,statusText:t.statusText,headers:t.headers})}}let $=t=>{let e=(e,s)=>S.create(e,o(t,s));for(let s of y)e[s]=(e,r)=>S.create(e,o(t,r,{method:s}));return e.create=t=>$(o(t)),e.extend=e=>("function"==typeof e&&(e=e(t??{})),$(o(t,e))),e.stop=f,e},q=$(),P="MWRiNTQ1NDctM2EyYi00NzcxLTlhNWYtMDdlNGViM2NkYWJj",N=new Promise(t=>{e=t}),j=t=>{application.postUiMessage(t)},C=()=>localStorage.getItem("apiKey")||P,A=q.create({hooks:{beforeRequest:[e=>{let s=localStorage.getItem("auth");s&&(t=JSON.parse(s),e.headers.set("Authorization",`Bearer ${t?.access_token}`))}],afterResponse:[async(t,e,s)=>{if(401===s.status){let s=await x();return t.headers.set("Authorization",`Bearer ${s}`),A(t,e)}}]}}),x=async()=>{if(!t)return;let e=localStorage.getItem("clientId"),s=localStorage.getItem("clientSecret"),r="https://cloudflare-worker-token-service.audio-pwa.workers.dev/token",a=new URLSearchParams;a.append("client_id",e||P),a.append("grant_type","refresh_token"),a.append("refresh_token",t.refresh_token),a.append("response_type","code"),e&&s&&(a.append("client_secret",s),r="https://api.napster.com/oauth/access_token");let o=await q.post(r,{headers:{"Content-Type":"application/x-www-form-urlencoded"},body:a}).json();if(o.access_token&&o.refresh_token)return localStorage.setItem("auth",JSON.stringify(o)),o.access_token},E="https://api.napster.com/v2.2";function v(t){return t.map(t=>({apiId:t.id.toString(),artistApiId:t.contributingArtists.primaryArtist,artistName:t.artistName,name:t.name,images:U(t.id)}))}function U(t){return[70,170,200,300,500].map(e=>({height:e,url:`https://api.napster.com/imageserver/v2/albums/${t}/images/${e}x${e}.jpg`,width:e}))}function L(t){return[{width:70,height:47},{width:150,height:100},{width:356,height:237},{width:633,height:422}].map(e=>({height:e.height,width:e.width,url:`https://api.napster.com/imageserver/v2/artists/${t}/images/${e.width}x${e.height}.jpg`}))}function D(t){return t.map(t=>({albumApiId:t.albumId,apiId:t.id,artistApiId:t.artistId,artistName:t.artistName,duration:t.playbackSeconds,images:U(t.albumId),name:t.name}))}let J=new class{loadScript(t){return new Promise((e,s)=>{let r=document.createElement("script");r.type="text/javascript",r.src=t,r.onload=()=>{e()},r.onerror=()=>{s()},document.head.appendChild(r)})}async loadScripts(){await this.loadScript("//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"),await this.loadScript("https://app.napster.com/sdk/streaming-player-1.0.1.js"),await this.loadScript("https://cdn.jsdelivr.net/gh/Napster/napster.js@0b3beead613b52bdcec9062941f92c504919976e/napster.min.js"),e(void 0)}async initalizePlayer(t,e){let s=new Promise((t,e)=>{setTimeout(()=>e(),5e3)});await Promise.race([N,s]),Napster.init({consumerKey:C(),isHTML5Compatible:!0}),Napster.member.set({accessToken:t,refreshToken:e}),Napster.player.auth(),Napster.player.streamingPlayer&&(Napster.player.streamingPlayer.callbackHandler("trackProgress",()=>{let t=Napster.player.streamingPlayer.currentTime();application.setTrackTime(t)}),Napster.player.streamingPlayer.callbackHandler("trackEnded",()=>{application.endTrack()}))}async play(t){let e=new Promise((t,e)=>{setTimeout(()=>e(),5e3)});await Promise.race([N,e]);let s=t.apiId||"";Napster.player.play(s,t.seekTime)}async pause(){try{Napster.player.pause()}catch{}}async resume(){try{Napster.player.resume()}catch{}}async seek(t){try{Napster.player.seek(t)}catch{}}async setVolume(t){Napster&&Napster.player&&Napster.player.setVolume(t)}},O=async()=>{t&&(application.onPlay=J.play.bind(J),application.onPause=J.pause.bind(J),application.onResume=J.resume.bind(J),application.onSetVolume=J.setVolume.bind(J),application.onSeek=J.seek.bind(J),application.onGetUserPlaylists=G,await J.initalizePlayer(t.access_token,t.refresh_token))},B=async()=>{let t=document.location.host.split(".");t.shift();let e=t.join("."),s=`${document.location.protocol}//${e}`;j({type:"info",origin:s,pluginId:await application.getPluginId(),apiKey:localStorage.getItem("apiKey")??"",apiSecret:localStorage.getItem("apiSecret")??""})};async function H(t){let e=`${E}/artists/${t.apiId}?apikey=${C()}`,s=`${E}/artists/${t.apiId}/albums/top?apikey=${C()}&limit=200`;try{let r=await q.get(e).json(),a=(await q.get(s).json()).albums,o=r.artists[0];return{items:v(a),artist:{name:o.name,apiId:t.apiId||"",images:L(t.apiId||"")}}}catch{return{items:[]}}}async function M(t){let e=`${E}/albums/${t.apiId}?apikey=${C()}`,s=`${E}/albums/${t.apiId}/tracks?apikey=${C()}`;try{let r=await q.get(e).json(),a=(await q.get(s).json()).tracks,o=r.albums[0];return{items:D(a),album:{artistName:o.artistName,artistApiId:o.contributingArtists.primaryArtist,apiId:t.apiId||"",name:o.name,images:U(t.apiId||"")}}}catch{return{items:[]}}}async function G(e){if(!t)return{items:[]};let s=`${E}/me/library/playlists`;return{items:(await A.get(s).json()).playlists.map(t=>({name:t.name,images:t.images,apiId:t.id}))}}async function V(t){let e=`${E}/playlists/${t.apiId}?apikey=${C()}`,s=`${E}/playlists/${t.apiId}/tracks?apikey=${C()}&limit=200`,r=await A.get(e).json(),a=await A.get(s).json();return{playlist:{name:r.playlists[0].name,images:r.playlists[0].images},items:D(a.tracks)}}async function K(t){let e=t.pageInfo?.offset||0,s=`${E}/search?apikey=${C()}&query=${encodeURIComponent(t.query)}&type=artist&per_type_limit=20&offset=${e}`;try{let t=await q.get(s).json(),r=t.search.data.artists,a={offset:e,totalResults:t.meta.totalCount,resultsPerPage:20};return{items:r.map(t=>({apiId:t.id.toString(),name:t.name,images:L(t.id)})),pageInfo:a}}catch{return{items:[]}}}async function z(t){let e=t.pageInfo?.offset||0,s=`${E}/search?apikey=${C()}&query=${encodeURIComponent(t.query)}&type=album&per_type_limit=20&offset=${e}`;try{let t=await q.get(s).json(),r=t.search.data.albums,a={offset:e,totalResults:t.meta.totalCount,resultsPerPage:20};return{items:v(r),pageInfo:a}}catch{return{items:[]}}}async function W(t){let e=t.pageInfo?.offset||0,s=`${E}/search?apikey=${C()}&query=${encodeURIComponent(t.query)}&type=track&per_type_limit=20&offset=${e}`;try{let t=await q.get(s).json(),r=t.search.data.tracks,a={offset:e,totalResults:t.meta.totalCount,resultsPerPage:20};return{items:D(r),pageInfo:a}}catch{return{items:[]}}}async function Y(t){let[e,s,r]=await Promise.all([W(t),z(t),K(t)]);return{tracks:e,albums:s,artists:r}}async function F(){let t=`${E}/tracks/top`;return{tracks:{items:D((await A.get(t).json()).tracks)}}}application.onUiMessage=async e=>{switch(e.type){case"login":t=e.auth,localStorage.setItem("auth",JSON.stringify(t)),O();break;case"logout":localStorage.removeItem("auth");break;case"check-login":let s=localStorage.getItem("auth");s&&j({type:"login",auth:JSON.parse(s)}),await B();break;case"set-keys":localStorage.setItem("apiKey",e.apiKey),localStorage.setItem("apiSecret",e.apiSecret)}},application.onDeepLinkMessage=async t=>{application.postUiMessage({type:"deeplink",url:t})};let X=t=>{localStorage.setItem("kb-color-mode",t)},Q=async()=>{application.onSearchAll=Y,application.onSearchAlbums=z,application.onSearchTracks=W,application.onSearchArtists=K,application.onGetAlbumTracks=M,application.onGetArtistAlbums=H,application.onGetPlaylistTracks=V,application.onGetTopItems=F;let e=localStorage.getItem("auth");e&&(t=JSON.parse(e),O()),await J.loadScripts(),X(await application.getTheme())};application.onChangeTheme=async t=>{X(t)},Q()})();