class P extends Error{response;request;options;constructor(t,s,r){const a=t.status||t.status===0?t.status:"",o=t.statusText||"",n=`${a} ${o}`.trim(),i=n?`status code ${n}`:"an unknown error";super(`Request failed with ${i}: ${s.method} ${s.url}`),this.name="HTTPError",this.response=t,this.request=s,this.options=r}}class N extends Error{request;constructor(t){super(`Request timed out: ${t.method} ${t.url}`),this.name="TimeoutError",this.request=t}}const f=e=>e!==null&&typeof e=="object",g=(...e)=>{for(const t of e)if((!f(t)||Array.isArray(t))&&t!==void 0)throw new TypeError("The `options` argument must be an object");return T({},...e)},j=(e={},t={})=>{const s=new globalThis.Headers(e),r=t instanceof globalThis.Headers,a=new globalThis.Headers(t);for(const[o,n]of a.entries())r&&n==="undefined"||n===void 0?s.delete(o):s.set(o,n);return s};function b(e,t,s){return Object.hasOwn(t,s)&&t[s]===void 0?[]:T(e[s]??[],t[s]??[])}const C=(e={},t={})=>({beforeRequest:b(e,t,"beforeRequest"),beforeRetry:b(e,t,"beforeRetry"),afterResponse:b(e,t,"afterResponse"),beforeError:b(e,t,"beforeError")}),T=(...e)=>{let t={},s={},r={};for(const a of e)if(Array.isArray(a))Array.isArray(t)||(t=[]),t=[...t,...a];else if(f(a)){for(let[o,n]of Object.entries(a))f(n)&&o in t&&(n=T(t[o],n)),t={...t,[o]:n};f(a.hooks)&&(r=C(r,a.hooks),t.hooks=r),f(a.headers)&&(s=j(s,a.headers),t.headers=s)}return t},D=(()=>{let e=!1,t=!1;const s=typeof globalThis.ReadableStream=="function",r=typeof globalThis.Request=="function";if(s&&r)try{t=new globalThis.Request("https://empty.invalid",{body:new globalThis.ReadableStream,method:"POST",get duplex(){return e=!0,"half"}}).headers.has("Content-Type")}catch(a){if(a instanceof Error&&a.message==="unsupported BodyInit type")return!1;throw a}return e&&!t})(),B=typeof globalThis.AbortController=="function",V=typeof globalThis.ReadableStream=="function",G=typeof globalThis.FormData=="function",x=["get","post","put","patch","head","delete"],Y={json:"application/json",text:"text/*",formData:"multipart/form-data",arrayBuffer:"*/*",blob:"*/*"},k=2147483647,E=Symbol("stop"),F={json:!0,parseJson:!0,stringifyJson:!0,searchParams:!0,prefixUrl:!0,retry:!0,timeout:!0,hooks:!0,throwHttpErrors:!0,onDownloadProgress:!0,fetch:!0},W={method:!0,headers:!0,body:!0,mode:!0,credentials:!0,cache:!0,redirect:!0,referrer:!0,referrerPolicy:!0,integrity:!0,keepalive:!0,signal:!0,window:!0,dispatcher:!0,duplex:!0,priority:!0},X=e=>x.includes(e)?e.toUpperCase():e,Q=["get","put","head","delete","options","trace"],Z=[408,413,429,500,502,503,504],tt=[413,429,503],$={limit:2,methods:Q,statusCodes:Z,afterStatusCodes:tt,maxRetryAfter:Number.POSITIVE_INFINITY,backoffLimit:Number.POSITIVE_INFINITY,delay:e=>.3*2**(e-1)*1e3},et=(e={})=>{if(typeof e=="number")return{...$,limit:e};if(e.methods&&!Array.isArray(e.methods))throw new Error("retry.methods must be an array");if(e.statusCodes&&!Array.isArray(e.statusCodes))throw new Error("retry.statusCodes must be an array");return{...$,...e}};async function st(e,t,s,r){return new Promise((a,o)=>{const n=setTimeout(()=>{s&&s.abort(),o(new N(e))},r.timeout);r.fetch(e,t).then(a).catch(o).then(()=>{clearTimeout(n)})})}async function rt(e,{signal:t}){return new Promise((s,r)=>{t&&(t.throwIfAborted(),t.addEventListener("abort",a,{once:!0}));function a(){clearTimeout(o),r(t.reason)}const o=setTimeout(()=>{t?.removeEventListener("abort",a),s()},e)})}const at=(e,t)=>{const s={};for(const r in t)!(r in W)&&!(r in F)&&!(r in e)&&(s[r]=t[r]);return s};class w{static create(t,s){const r=new w(t,s),a=async()=>{if(typeof r._options.timeout=="number"&&r._options.timeout>k)throw new RangeError(`The \`timeout\` option cannot be greater than ${k}`);await Promise.resolve();let i=await r._fetch();for(const m of r._options.hooks.afterResponse){const c=await m(r.request,r._options,r._decorateResponse(i.clone()));c instanceof globalThis.Response&&(i=c)}if(r._decorateResponse(i),!i.ok&&r._options.throwHttpErrors){let m=new P(i,r.request,r._options);for(const c of r._options.hooks.beforeError)m=await c(m);throw m}if(r._options.onDownloadProgress){if(typeof r._options.onDownloadProgress!="function")throw new TypeError("The `onDownloadProgress` option must be a function");if(!V)throw new Error("Streams are not supported in your environment. `ReadableStream` is missing.");return r._stream(i.clone(),r._options.onDownloadProgress)}return i},n=r._options.retry.methods.includes(r.request.method.toLowerCase())?r._retry(a):a();for(const[i,m]of Object.entries(Y))n[i]=async()=>{r.request.headers.set("accept",r.request.headers.get("accept")||m);const c=await n;if(i==="json"){if(c.status===204||(await c.clone().arrayBuffer()).byteLength===0)return"";if(s.parseJson)return s.parseJson(await c.text())}return c[i]()};return n}request;abortController;_retryCount=0;_input;_options;constructor(t,s={}){if(this._input=t,this._options={...s,headers:j(this._input.headers,s.headers),hooks:C({beforeRequest:[],beforeRetry:[],beforeError:[],afterResponse:[]},s.hooks),method:X(s.method??this._input.method??"GET"),prefixUrl:String(s.prefixUrl||""),retry:et(s.retry),throwHttpErrors:s.throwHttpErrors!==!1,timeout:s.timeout??1e4,fetch:s.fetch??globalThis.fetch.bind(globalThis)},typeof this._input!="string"&&!(this._input instanceof URL||this._input instanceof globalThis.Request))throw new TypeError("`input` must be a string, URL, or Request");if(this._options.prefixUrl&&typeof this._input=="string"){if(this._input.startsWith("/"))throw new Error("`input` must not begin with a slash when using `prefixUrl`");this._options.prefixUrl.endsWith("/")||(this._options.prefixUrl+="/"),this._input=this._options.prefixUrl+this._input}if(B){this.abortController=new globalThis.AbortController;const r=this._options.signal??this._input.signal;r?.aborted&&this.abortController.abort(r?.reason),r?.addEventListener("abort",()=>{this.abortController.abort(r.reason)}),this._options.signal=this.abortController.signal}if(D&&(this._options.duplex="half"),this._options.json!==void 0&&(this._options.body=this._options.stringifyJson?.(this._options.json)??JSON.stringify(this._options.json),this._options.headers.set("content-type",this._options.headers.get("content-type")??"application/json")),this.request=new globalThis.Request(this._input,this._options),this._options.searchParams){const a="?"+(typeof this._options.searchParams=="string"?this._options.searchParams.replace(/^\?/,""):new URLSearchParams(this._options.searchParams).toString()),o=this.request.url.replace(/(?:\?.*?)?(?=#|$)/,a);(G&&this._options.body instanceof globalThis.FormData||this._options.body instanceof URLSearchParams)&&!(this._options.headers&&this._options.headers["content-type"])&&this.request.headers.delete("content-type"),this.request=new globalThis.Request(new globalThis.Request(o,{...this.request}),this._options)}}_calculateRetryDelay(t){if(this._retryCount++,this._retryCount>this._options.retry.limit||t instanceof N)throw t;if(t instanceof P){if(!this._options.retry.statusCodes.includes(t.response.status))throw t;const r=t.response.headers.get("Retry-After")??t.response.headers.get("RateLimit-Reset")??t.response.headers.get("X-RateLimit-Reset")??t.response.headers.get("X-Rate-Limit-Reset");if(r&&this._options.retry.afterStatusCodes.includes(t.response.status)){let a=Number(r)*1e3;Number.isNaN(a)?a=Date.parse(r)-Date.now():a>=Date.parse("2024-01-01")&&(a-=Date.now());const o=this._options.retry.maxRetryAfter??a;return a<o?a:o}if(t.response.status===413)throw t}const s=this._options.retry.delay(this._retryCount);return Math.min(this._options.retry.backoffLimit,s)}_decorateResponse(t){return this._options.parseJson&&(t.json=async()=>this._options.parseJson(await t.text())),t}async _retry(t){try{return await t()}catch(s){const r=Math.min(this._calculateRetryDelay(s),k);if(this._retryCount<1)throw s;await rt(r,{signal:this._options.signal});for(const a of this._options.hooks.beforeRetry)if(await a({request:this.request,options:this._options,error:s,retryCount:this._retryCount})===E)return;return this._retry(t)}}async _fetch(){for(const r of this._options.hooks.beforeRequest){const a=await r(this.request,this._options);if(a instanceof Request){this.request=a;break}if(a instanceof Response)return a}const t=at(this.request,this._options),s=this.request;return this.request=s.clone(),this._options.timeout===!1?this._options.fetch(s,t):st(s,t,this.abortController,this._options)}_stream(t,s){const r=Number(t.headers.get("content-length"))||0;let a=0;return t.status===204?(s&&s({percent:1,totalBytes:r,transferredBytes:a},new Uint8Array),new globalThis.Response(null,{status:t.status,statusText:t.statusText,headers:t.headers})):new globalThis.Response(new globalThis.ReadableStream({async start(o){const n=t.body.getReader();s&&s({percent:0,transferredBytes:0,totalBytes:r},new Uint8Array);async function i(){const{done:m,value:c}=await n.read();if(m){o.close();return}if(s){a+=c.byteLength;const I=r===0?0:a/r;s({percent:I,transferredBytes:a,totalBytes:r},c)}o.enqueue(c),await i()}await i()}}),{status:t.status,statusText:t.statusText,headers:t.headers})}}/*! MIT License Â© Sindre Sorhus */const R=e=>{const t=(s,r)=>w.create(s,g(e,r));for(const s of x)t[s]=(r,a)=>w.create(r,g(e,a,{method:s}));return t.create=s=>R(g(s)),t.extend=s=>(typeof s=="function"&&(s=s(e??{})),R(g(e,s))),t.stop=E,t},d=R(),q="MWRiNTQ1NDctM2EyYi00NzcxLTlhNWYtMDdlNGViM2NkYWJj",ot="https://cloudflare-worker-token-service.audio-pwa.workers.dev/token",nt="https://api.napster.com/oauth/access_token";let l,U,A=new Promise(e=>{U=e});const v=e=>{application.postUiMessage(e)},h=()=>localStorage.getItem("apiKey")||q,y=d.create({hooks:{beforeRequest:[e=>{const t=localStorage.getItem("auth");t&&(l=JSON.parse(t),e.headers.set("Authorization",`Bearer ${l?.access_token}`))}],afterResponse:[async(e,t,s)=>{if(s.status===401){const r=await it();return e.headers.set("Authorization",`Bearer ${r}`),y(e,t)}}]}}),it=async()=>{if(!l)return;const e=localStorage.getItem("clientId"),t=localStorage.getItem("clientSecret");let s=ot;const r=new URLSearchParams;r.append("client_id",e||q),r.append("grant_type","refresh_token"),r.append("refresh_token",l.refresh_token),r.append("response_type","code"),e&&t&&(r.append("client_secret",t),s=nt);const a=await d.post(s,{headers:{"Content-Type":"application/x-www-form-urlencoded"},body:r}).json();if(a.access_token&&a.refresh_token)return localStorage.setItem("auth",JSON.stringify(a)),a.access_token},u="https://api.napster.com/v2.2";function O(e){return e.map(t=>({apiId:t.id.toString(),artistApiId:t.contributingArtists.primaryArtist,artistName:t.artistName,name:t.name,images:S(t.id)}))}function ct(e){return e.map(t=>({apiId:t.id.toString(),name:t.name,images:L(t.id)}))}function S(e){return[70,170,200,300,500].map(s=>({height:s,url:`https://api.napster.com/imageserver/v2/albums/${e}/images/${s}x${s}.jpg`,width:s}))}function L(e){return[{width:70,height:47},{width:150,height:100},{width:356,height:237},{width:633,height:422}].map(s=>({height:s.height,width:s.width,url:`https://api.napster.com/imageserver/v2/artists/${e}/images/${s.width}x${s.height}.jpg`}))}function _(e){return e.map(t=>({albumApiId:t.albumId,apiId:t.id,artistApiId:t.artistId,artistName:t.artistName,duration:t.playbackSeconds,images:S(t.albumId),name:t.name}))}class pt{loadScript(t){return new Promise((s,r)=>{const a=document.createElement("script");a.type="text/javascript",a.src=t,a.onload=()=>{s()},a.onerror=()=>{r()},document.head.appendChild(a)})}async loadScripts(){await this.loadScript("//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"),await this.loadScript("https://app.napster.com/sdk/streaming-player-1.0.1.js"),await this.loadScript("https://cdn.jsdelivr.net/gh/Napster/napster.js@0b3beead613b52bdcec9062941f92c504919976e/napster.min.js"),U(void 0)}async initalizePlayer(t,s){const r=new Promise((a,o)=>{setTimeout(()=>o(),5e3)});await Promise.race([A,r]),Napster.init({consumerKey:h(),isHTML5Compatible:!0}),Napster.member.set({accessToken:t,refreshToken:s}),Napster.player.auth(),Napster.player.streamingPlayer&&(Napster.player.streamingPlayer.callbackHandler("trackProgress",()=>{const a=Napster.player.streamingPlayer.currentTime();application.setTrackTime(a)}),Napster.player.streamingPlayer.callbackHandler("trackEnded",()=>{application.endTrack()}))}async play(t){const s=new Promise((a,o)=>{setTimeout(()=>o(),5e3)});await Promise.race([A,s]);const r=t.apiId||"";Napster.player.play(r,t.seekTime)}async pause(){try{Napster.player.pause()}catch{}}async resume(){try{Napster.player.resume()}catch{}}async seek(t){try{Napster.player.seek(t)}catch{}}async setVolume(t){Napster&&Napster.player&&Napster.player.setVolume(t)}}const p=new pt,M=async()=>{l&&(application.onPlay=p.play.bind(p),application.onPause=p.pause.bind(p),application.onResume=p.resume.bind(p),application.onSetVolume=p.setVolume.bind(p),application.onSeek=p.seek.bind(p),application.onGetUserPlaylists=mt,await p.initalizePlayer(l.access_token,l.refresh_token))},lt=async()=>{const t=document.location.host.split(".");t.shift();const s=t.join("."),r=`${document.location.protocol}//${s}`,a=await application.getPluginId(),o=localStorage.getItem("apiKey")??"",n=localStorage.getItem("apiSecret")??"";v({type:"info",origin:r,pluginId:a,apiKey:o,apiSecret:n})};application.onUiMessage=async e=>{switch(e.type){case"login":l=e.auth,localStorage.setItem("auth",JSON.stringify(l)),M();break;case"logout":localStorage.removeItem("auth");break;case"check-login":const t=localStorage.getItem("auth");t&&v({type:"login",auth:JSON.parse(t)}),await lt();break;case"set-keys":localStorage.setItem("apiKey",e.apiKey),localStorage.setItem("apiSecret",e.apiSecret);break}};application.onDeepLinkMessage=async e=>{application.postUiMessage({type:"deeplink",url:e})};async function ut(e){const s=`${u}/artists/${e.apiId}?apikey=${h()}`,r=`${u}/artists/${e.apiId}/albums/top?apikey=${h()}&limit=200`;try{const a=await d.get(s).json(),n=(await d.get(r).json()).albums,i=a.artists[0];return{items:O(n),artist:{name:i.name,apiId:e.apiId||"",images:L(e.apiId||"")}}}catch{return{items:[]}}}async function ht(e){const t=`${u}/albums/${e.apiId}?apikey=${h()}`,s=`${u}/albums/${e.apiId}/tracks?apikey=${h()}`;try{const r=await d.get(t).json(),o=(await d.get(s).json()).tracks,n=r.albums[0];return{items:_(o),album:{artistName:n.artistName,artistApiId:n.contributingArtists.primaryArtist,apiId:e.apiId||"",name:n.name,images:S(e.apiId||"")}}}catch{return{items:[]}}}async function mt(e){if(!l)return{items:[]};const t=`${u}/me/library/playlists`;return{items:(await y.get(t).json()).playlists.map(a=>({name:a.name,images:a.images,apiId:a.id}))}}async function dt(e){const s=`${u}/playlists/${e.apiId}?apikey=${h()}`,r=`${u}/playlists/${e.apiId}/tracks?apikey=${h()}&limit=200`,a=await y.get(s).json(),o=await y.get(r).json();return{playlist:{name:a.playlists[0].name,images:a.playlists[0].images},items:_(o.tracks)}}async function H(e){const s=e.pageInfo?.offset||0,r=`${u}/search?apikey=${h()}&query=${encodeURIComponent(e.query)}&type=artist&per_type_limit=20&offset=${s}`;try{const a=await d.get(r).json(),o=a.search.data.artists,n={offset:s,totalResults:a.meta.totalCount,resultsPerPage:20};return{items:ct(o),pageInfo:n}}catch{return{items:[]}}}async function J(e){const s=e.pageInfo?.offset||0,r=`${u}/search?apikey=${h()}&query=${encodeURIComponent(e.query)}&type=album&per_type_limit=20&offset=${s}`;try{const a=await d.get(r).json(),o=a.search.data.albums,n={offset:s,totalResults:a.meta.totalCount,resultsPerPage:20};return{items:O(o),pageInfo:n}}catch{return{items:[]}}}async function K(e){const s=e.pageInfo?.offset||0,r=`${u}/search?apikey=${h()}&query=${encodeURIComponent(e.query)}&type=track&per_type_limit=20&offset=${s}`;try{const a=await d.get(r).json(),o=a.search.data.tracks,n={offset:s,totalResults:a.meta.totalCount,resultsPerPage:20};return{items:_(o),pageInfo:n}}catch{return{items:[]}}}async function ft(e){const[t,s,r]=await Promise.all([K(e),J(e),H(e)]);return{tracks:t,albums:s,artists:r}}async function yt(){const e=`${u}/tracks/top`,t=await y.get(e).json();return{tracks:{items:_(t.tracks)}}}const z=e=>{localStorage.setItem("kb-color-mode",e)},gt=async()=>{application.onSearchAll=ft,application.onSearchAlbums=J,application.onSearchTracks=K,application.onSearchArtists=H,application.onGetAlbumTracks=ht,application.onGetArtistAlbums=ut,application.onGetPlaylistTracks=dt,application.onGetTopItems=yt;const e=localStorage.getItem("auth");e&&(l=JSON.parse(e),M()),await p.loadScripts();const t=await application.getTheme();z(t)};application.onChangeTheme=async e=>{z(e)};gt();
